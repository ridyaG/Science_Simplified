<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Science Simplified ‚Äì NEET MCQ Practice</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --gold:#C89B14;--gold-light:#E8B91A;--gold-dark:#A07A0A;
    --blue:#1A3E8C;--blue-light:#2551B5;--blue-dark:#0F2560;
    --bg-light:#F5F7FA;--text-dark:#1A1A2E;--text-mid:#444466;
    --green:#1A6B3C;--green-light:#2E9B5A;--red:#C0392B;
    --amber:#C05020;--purple:#5A2D82;--purple-light:#7B3FB0;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Nunito',sans-serif;background:var(--bg-light);min-height:100vh;color:var(--text-dark);overflow-x:hidden;}
  h1,h2,h3,h4,.poppins{font-family:'Poppins',sans-serif;}

  /* SPLASH */
  #splash{position:fixed;inset:0;z-index:1000;background:linear-gradient(160deg,var(--blue-dark) 0%,var(--blue) 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;overflow:hidden;}
  #splash.fade-out{animation:splashFadeOut 0.4s ease forwards;}
  @keyframes splashFadeOut{to{opacity:0;pointer-events:none;}}
  .splash-atom{position:relative;width:140px;height:140px;display:flex;align-items:center;justify-content:center;opacity:0;animation:atomIn 0.6s 0.1s ease forwards;}
  @keyframes atomIn{from{opacity:0;transform:scale(0.3)}to{opacity:1;transform:scale(1)}}
  .atom-nucleus{width:32px;height:32px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#FFD700,var(--gold));box-shadow:0 0 24px 8px rgba(200,155,20,0.7);position:absolute;z-index:2;animation:nucGlow 1.5s 2s ease-in-out infinite alternate;}
  @keyframes nucGlow{from{box-shadow:0 0 24px 8px rgba(200,155,20,0.7)}to{box-shadow:0 0 48px 16px rgba(200,155,20,1)}}
  .orbit{position:absolute;border-radius:50%;border:2.5px solid rgba(200,155,20,0);animation:orbitDraw 0.6s ease forwards;}
  .orbit-1{width:110px;height:42px;transform:rotate(0deg);animation-delay:0.5s}
  .orbit-2{width:110px;height:42px;transform:rotate(60deg);animation-delay:0.7s}
  .orbit-3{width:110px;height:42px;transform:rotate(120deg);animation-delay:0.9s}
  @keyframes orbitDraw{from{border-color:rgba(200,155,20,0)}to{border-color:rgba(200,155,20,0.85)}}
  .electron{position:absolute;width:8px;height:8px;border-radius:50%;background:var(--gold-light);box-shadow:0 0 8px 3px var(--gold);}
  .orbit-1 .electron{animation:spin1 2.4s 1.1s linear infinite}
  .orbit-2 .electron{animation:spin1 2.1s 1.3s linear infinite reverse}
  .orbit-3 .electron{animation:spin1 1.9s 1.5s linear infinite}
  @keyframes spin1{from{transform:translate(51px,-4px) rotate(0deg) translateX(-51px)}to{transform:translate(51px,-4px) rotate(360deg) translateX(-51px)}}
  .benzene-left,.benzene-right{position:absolute;opacity:0;}
  .benzene-left{left:-60px;animation:benzIn 0.5s 0.9s ease forwards}
  .benzene-right{right:-60px;animation:benzInR 0.5s 1.1s ease forwards}
  @keyframes benzIn{from{opacity:0;transform:translateX(-40px)}to{opacity:0.5;transform:translateX(0)}}
  @keyframes benzInR{from{opacity:0;transform:translateX(40px)}to{opacity:0.5;transform:translateX(0)}}
  .splash-title{opacity:0;text-align:center;animation:textUp 0.5s 1.5s ease forwards;font-family:'Poppins',sans-serif;font-weight:800;font-size:1.55rem;color:#fff;letter-spacing:0.08em;text-shadow:0 2px 16px rgba(200,155,20,0.3);}
  .splash-institute{font-size:0.7rem;letter-spacing:0.22em;color:var(--gold-light);font-weight:600;margin-top:2px;display:block;}
  @keyframes textUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  .splash-tagline{opacity:0;animation:textUp 0.5s 2.1s ease forwards;font-family:'Nunito',sans-serif;color:rgba(255,255,255,0.7);font-size:0.95rem;font-style:italic;}
  .tagline-dot{color:var(--gold);font-style:normal;}

  /* APP */
  #app{display:none;min-height:100vh;flex-direction:column;}
  #app.visible{display:flex;animation:appFadeIn 0.4s ease;}
  @keyframes appFadeIn{from{opacity:0}to{opacity:1}}

  /* HEADER */
  .header{background:#fff;border-bottom:2px solid rgba(200,155,20,0.13);padding:12px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 12px rgba(26,62,140,0.07);position:sticky;top:0;z-index:100;}
  .logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--blue-dark),var(--blue));border-radius:10px;display:flex;align-items:center;justify-content:center;}
  .logo-text{font-family:'Poppins',sans-serif;font-weight:700;font-size:0.8rem;color:var(--blue);line-height:1.2;}
  .logo-text span{color:var(--gold);display:block;font-size:0.65rem;font-weight:600;}
  .header-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
  .header-greeting{font-size:0.82rem;color:var(--text-mid);font-weight:600;}
  .user-btn{background:linear-gradient(135deg,var(--blue-dark),var(--blue));color:#fff;border:none;padding:6px 12px;border-radius:8px;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.75rem;cursor:pointer;transition:all 0.15s;}
  .user-btn:hover{transform:scale(1.04);}

  /* SCREENS */
  .screen{display:none;flex-direction:column;flex:1;}
  .screen.active{display:flex;}

  /* HOME */
  .home-hero{padding:28px 20px 12px;text-align:center;}
  .home-hero h1{font-size:clamp(1.2rem,5vw,1.8rem);color:var(--blue);line-height:1.3;margin-bottom:8px;}
  .home-hero p{color:var(--text-mid);font-size:0.9rem;}
  .subject-grid{padding:12px 16px 8px;display:flex;flex-direction:column;gap:12px;}
  @media(min-width:560px){.subject-grid{flex-direction:row;flex-wrap:wrap;justify-content:center;}.subject-card{flex:1;min-width:140px;max-width:195px;}}
  .subject-card{border-radius:18px;padding:20px 16px;cursor:pointer;color:#fff;box-shadow:0 6px 28px rgba(0,0,0,0.18);transition:transform 0.18s,box-shadow 0.18s;position:relative;overflow:hidden;display:flex;flex-direction:column;gap:7px;}
  .subject-card:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 12px 40px rgba(0,0,0,0.22);}
  .subject-card:active{transform:scale(0.97);}
  .subject-card::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,0.05);border-radius:inherit;}
  .card-physics{background:linear-gradient(135deg,#1A3E8C,#2551B5);}
  .card-biology{background:linear-gradient(135deg,#1A6B3C,#2E9B5A);}
  .card-chemistry{background:linear-gradient(135deg,#7A2A0A,#C05020);}
  .card-lb{background:linear-gradient(135deg,#5A2D82,#8B5CF6);}
  .card-ana{background:linear-gradient(135deg,#0F2560,#1A3E8C);}
  .card-icon{font-size:2rem;line-height:1;}
  .card-name{font-family:'Poppins',sans-serif;font-weight:700;font-size:1.1rem;}
  .card-meta{font-size:0.78rem;opacity:0.85;}

  /* TOPIC */
  .topic-header{background:linear-gradient(135deg,var(--blue-dark),var(--blue));padding:14px 16px;display:flex;align-items:center;gap:12px;color:#fff;}
  .topic-header-title{font-family:'Poppins',sans-serif;font-weight:700;font-size:1.15rem;flex:1;}
  .back-btn{background:rgba(255,255,255,0.15);border:none;color:#fff;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:1rem;display:flex;align-items:center;gap:4px;font-family:'Nunito',sans-serif;font-weight:600;transition:background 0.15s;white-space:nowrap;}
  .back-btn:hover{background:rgba(255,255,255,0.25);}
  .tab-bar{display:flex;background:#fff;border-bottom:2px solid rgba(26,62,140,0.1);}
  .tab-btn{flex:1;padding:11px;border:none;background:none;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.9rem;color:var(--text-mid);cursor:pointer;border-bottom:3px solid transparent;transition:all 0.18s;}
  .tab-btn.active{color:var(--blue);border-bottom-color:var(--gold);background:rgba(200,155,20,0.05);}
  .chapter-list{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px;}
  .chapter-card{background:#fff;border-radius:14px;padding:14px 16px;box-shadow:0 2px 10px rgba(26,62,140,0.07);display:flex;align-items:center;gap:12px;border-left:5px solid var(--blue);transition:box-shadow 0.15s,transform 0.15s;}
  .chapter-card:hover{box-shadow:0 5px 20px rgba(26,62,140,0.13);transform:translateX(2px);}
  .chapter-num{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--blue-dark),var(--blue));color:#fff;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.85rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .chapter-info{flex:1;min-width:0;}
  .chapter-name{font-family:'Poppins',sans-serif;font-weight:600;font-size:0.9rem;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .chapter-sub{font-size:0.75rem;color:var(--text-mid);margin-top:2px;}
  .progress-bar-wrap{height:5px;background:#eee;border-radius:99px;margin-top:6px;}
  .progress-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--gold),var(--gold-light));transition:width 0.3s;}
  .start-btn{background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#fff;border:none;padding:8px 16px;border-radius:10px;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;white-space:nowrap;box-shadow:0 3px 12px rgba(200,155,20,0.35);transition:all 0.15s;}
  .start-btn:hover{transform:scale(1.05);}

  /* LEVEL MODAL */
  .modal-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.6);display:flex;align-items:flex-end;justify-content:center;}
  .bottom-sheet{background:#fff;border-radius:24px 24px 0 0;padding:24px 20px 32px;width:100%;max-width:480px;animation:slideUp 0.3s ease;}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
  .sheet-title{font-family:'Poppins',sans-serif;font-weight:800;font-size:1.1rem;color:var(--blue);text-align:center;margin-bottom:4px;}
  .sheet-sub{text-align:center;font-size:0.83rem;color:var(--text-mid);margin-bottom:18px;}
  .level-cards{display:flex;flex-direction:column;gap:11px;}
  .level-card{border-radius:14px;padding:15px 17px;cursor:pointer;border:2.5px solid transparent;display:flex;align-items:center;gap:14px;transition:all 0.18s;}
  .level-card:hover{transform:translateX(4px);}
  .level-basic{background:rgba(46,155,90,0.06);border-color:rgba(46,155,90,0.2);}
  .level-basic:hover{border-color:var(--green-light);}
  .level-inter{background:rgba(200,155,20,0.06);border-color:rgba(200,155,20,0.2);}
  .level-inter:hover{border-color:var(--gold);}
  .level-adv{background:rgba(192,57,43,0.06);border-color:rgba(192,57,43,0.2);}
  .level-adv:hover{border-color:var(--red);}
  .level-icon{font-size:1.9rem;flex-shrink:0;}
  .level-name{font-family:'Poppins',sans-serif;font-weight:700;font-size:0.97rem;}
  .level-basic .level-name{color:var(--green);}
  .level-inter .level-name{color:var(--gold-dark);}
  .level-adv .level-name{color:var(--red);}
  .level-desc{font-size:0.78rem;color:var(--text-mid);margin-top:2px;}
  .sheet-cancel{width:100%;margin-top:13px;padding:12px;border:none;background:#f5f5f5;border-radius:12px;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.9rem;color:var(--text-mid);cursor:pointer;}

  /* LOADING */
  .loading-screen{background:#0F1020;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;flex:1;}
  .spinner{width:56px;height:56px;border-radius:50%;border:4px solid rgba(200,155,20,0.15);border-top-color:var(--gold);animation:spin 0.9s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-badge{padding:5px 16px;border-radius:99px;background:rgba(200,155,20,0.15);border:1px solid rgba(200,155,20,0.3);color:var(--gold);font-family:'Poppins',sans-serif;font-weight:700;font-size:0.8rem;}
  .loading-text{font-family:'Poppins',sans-serif;font-weight:600;color:rgba(255,255,255,0.8);font-size:1rem;text-align:center;}
  .loading-sub{font-size:0.78rem;color:rgba(255,255,255,0.35);margin-top:-12px;text-align:center;}

  /* QUIZ */
  .quiz-screen{background:#0F1020;}
  .quiz-topbar{background:#16192E;padding:12px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(200,155,20,0.15);}
  .quiz-title{flex:1;text-align:center;font-family:'Poppins',sans-serif;font-weight:600;color:#fff;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .score-pill{background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#fff;padding:5px 14px;border-radius:99px;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9rem;white-space:nowrap;box-shadow:0 2px 10px rgba(200,155,20,0.4);}
  .score-pill.pop{animation:scorePop 0.35s ease;}
  .score-pill.shake{animation:scoreShake 0.4s ease;}
  @keyframes scorePop{0%{transform:scale(1)}40%{transform:scale(1.25)}70%{transform:scale(0.95)}100%{transform:scale(1)}}
  @keyframes scoreShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
  .level-pill{padding:3px 10px;border-radius:99px;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.72rem;}
  .pill-basic{background:rgba(46,155,90,0.2);color:#6EE7B7;}
  .pill-inter{background:rgba(200,155,20,0.2);color:var(--gold);}
  .pill-adv{background:rgba(192,57,43,0.2);color:#ff6b6b;}
  .quiz-progress-wrap{background:#16192E;padding:8px 16px 12px;}
  .quiz-progress-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:99px;overflow:hidden;}
  .quiz-progress-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--gold),#FFD700);transition:width 0.4s ease;}
  .quiz-counter{font-size:0.78rem;color:rgba(255,255,255,0.5);margin-top:5px;text-align:right;}
  .quiz-content{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;}
  .question-card{background:#1E2240;border-radius:18px;padding:20px 18px;box-shadow:0 4px 24px rgba(0,0,0,0.4);border:1px solid rgba(200,155,20,0.12);animation:qCardIn 0.3s ease;}
  @keyframes qCardIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  .q-num{font-size:0.75rem;color:var(--gold);font-weight:700;letter-spacing:0.08em;margin-bottom:10px;}
  .q-text{color:#fff;font-size:1rem;line-height:1.65;}
  .options-list{display:flex;flex-direction:column;gap:10px;}
  .opt-btn{background:#1E2240;border:2px solid rgba(255,255,255,0.1);border-radius:13px;padding:13px 16px;display:flex;align-items:flex-start;gap:12px;cursor:pointer;text-align:left;transition:border-color 0.15s,background 0.15s,transform 0.1s;animation:optIn 0.25s ease backwards;width:100%;}
  .opt-btn:nth-child(1){animation-delay:0.05s}.opt-btn:nth-child(2){animation-delay:0.1s}.opt-btn:nth-child(3){animation-delay:0.15s}.opt-btn:nth-child(4){animation-delay:0.2s}
  @keyframes optIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
  .opt-btn:hover:not(:disabled){border-color:var(--gold);background:rgba(200,155,20,0.07);transform:translateX(3px);}
  .opt-btn:disabled{cursor:default;}
  .opt-letter{width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,0.08);color:var(--gold);font-family:'Poppins',sans-serif;font-weight:700;font-size:0.82rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .opt-text{color:rgba(255,255,255,0.9);font-size:0.93rem;line-height:1.5;padding-top:4px;}
  .opt-btn.correct{border-color:var(--green-light);background:rgba(46,155,90,0.15);}
  .opt-btn.correct .opt-letter{background:var(--green-light);color:#fff;}
  .opt-btn.wrong{border-color:var(--red);background:rgba(192,57,43,0.15);}
  .opt-btn.wrong .opt-letter{background:var(--red);color:#fff;}
  .opt-btn.revealed{border-color:var(--green-light);background:rgba(46,155,90,0.08);opacity:0.7;}
  .opt-btn.revealed .opt-letter{background:var(--green-light);color:#fff;}
  .feedback{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:10px;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9rem;animation:feedIn 0.25s ease;}
  @keyframes feedIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
  .feedback.correct{background:rgba(46,155,90,0.2);color:var(--green-light);}
  .feedback.wrong{background:rgba(192,57,43,0.2);color:#ff6b6b;}
  .expl-box{background:#1E2240;border-radius:12px;padding:12px 14px;border-left:3px solid var(--gold);}
  .expl-label{font-size:0.72rem;font-weight:700;color:var(--gold);margin-bottom:6px;}
  .expl-text{color:rgba(255,255,255,0.85);font-size:0.88rem;line-height:1.55;}
  .next-btn{background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#fff;border:none;padding:14px;border-radius:14px;font-family:'Poppins',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;box-shadow:0 4px 20px rgba(200,155,20,0.4);transition:all 0.15s;animation:nextIn 0.3s ease;display:flex;align-items:center;justify-content:center;gap:8px;width:100%;}
  @keyframes nextIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .next-btn:hover{transform:translateY(-2px);}

  /* RESULTS */
  .results-screen{background:linear-gradient(160deg,var(--blue-dark) 0%,#0F1020 100%);}
  .results-content{flex:1;overflow-y:auto;padding:20px 16px;display:flex;flex-direction:column;gap:18px;align-items:center;}
  .score-ring-wrap{width:160px;height:160px;border-radius:50%;border:8px solid rgba(200,155,20,0.2);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;box-shadow:0 0 40px rgba(200,155,20,0.3);animation:ringIn 0.5s ease;}
  @keyframes ringIn{from{opacity:0;transform:scale(0.5)}to{opacity:1;transform:scale(1)}}
  .score-ring-svg{position:absolute;inset:-8px;}
  .score-big{font-family:'Poppins',sans-serif;font-weight:900;font-size:2.8rem;color:var(--gold);line-height:1;}
  .score-lbl{font-size:0.78rem;color:rgba(255,255,255,0.6);font-weight:600;}
  .perf-badge{padding:8px 24px;border-radius:99px;font-family:'Poppins',sans-serif;font-weight:700;font-size:1rem;animation:badgeIn 0.4s 0.3s ease backwards;box-shadow:0 4px 20px rgba(0,0,0,0.3);}
  @keyframes badgeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .perf-excellent{background:linear-gradient(135deg,#1A6B3C,#2E9B5A);color:#fff;}
  .perf-good{background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#fff;}
  .perf-practice{background:linear-gradient(135deg,var(--blue-dark),var(--blue));color:#fff;}
  .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%;animation:statsIn 0.4s 0.5s ease backwards;}
  @keyframes statsIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  .stat-box{background:rgba(255,255,255,0.07);border-radius:14px;padding:14px;text-align:center;border:1px solid rgba(255,255,255,0.08);}
  .stat-val{font-family:'Poppins',sans-serif;font-weight:800;font-size:1.6rem;color:#fff;}
  .stat-lbl{font-size:0.75rem;color:rgba(255,255,255,0.55);margin-top:2px;}
  .stat-box.g .stat-val{color:var(--green-light);}
  .stat-box.r .stat-val{color:#ff6b6b;}
  .stat-box.gold .stat-val{color:var(--gold);}
  .neet-box{background:linear-gradient(135deg,rgba(200,155,20,0.2),rgba(200,155,20,0.08));border:2px solid rgba(200,155,20,0.35);border-radius:16px;padding:16px;width:100%;text-align:center;animation:statsIn 0.4s 0.7s ease backwards;}
  .neet-lbl{color:rgba(255,255,255,0.7);font-size:0.8rem;margin-bottom:5px;}
  .neet-val{font-family:'Poppins',sans-serif;font-weight:900;font-size:2.2rem;color:var(--gold);}
  .neet-max{font-size:0.8rem;color:rgba(255,255,255,0.5);}
  .save-status{font-size:0.78rem;color:rgba(255,255,255,0.5);text-align:center;animation:statsIn 0.4s 0.9s ease backwards;}
  .result-btns{display:flex;flex-direction:column;gap:10px;width:100%;animation:statsIn 0.4s 1.1s ease backwards;}
  .result-btn{padding:14px;border-radius:14px;border:none;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.15s;}
  .result-btn.primary{background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#fff;box-shadow:0 4px 20px rgba(200,155,20,0.4);}
  .result-btn.secondary{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.15);}
  .result-btn:hover{transform:translateY(-2px);}

  /* REVIEW */
  .review-header{background:linear-gradient(135deg,var(--blue-dark),var(--blue));padding:14px 16px;display:flex;align-items:center;gap:12px;color:#fff;}
  .review-list{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:14px;}
  .review-card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(26,62,140,0.1);}
  .review-card.rc-c{border-left:5px solid var(--green-light);}
  .review-card.rc-w{border-left:5px solid var(--red);}
  .review-card.rc-s{border-left:5px solid #aaa;}
  .rc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:8px;}
  .rc-qnum{font-family:'Poppins',sans-serif;font-weight:700;font-size:0.8rem;color:var(--blue);}
  .rc-badge{padding:2px 10px;border-radius:99px;font-size:0.72rem;font-weight:700;}
  .rc-badge.c{background:rgba(46,155,90,0.15);color:var(--green);}
  .rc-badge.w{background:rgba(192,57,43,0.12);color:var(--red);}
  .rc-badge.s{background:rgba(0,0,0,0.06);color:#666;}
  .rc-q{font-size:0.92rem;color:var(--text-dark);line-height:1.6;margin-bottom:12px;}
  .rc-opts{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
  .rc-opt{padding:8px 12px;border-radius:9px;font-size:0.85rem;display:flex;align-items:flex-start;gap:8px;border:1.5px solid #eee;color:var(--text-dark);}
  .rc-opt b{flex-shrink:0;}
  .rc-opt.ic{background:rgba(46,155,90,0.1);border-color:var(--green-light);color:var(--green);}
  .rc-opt.iw{background:rgba(192,57,43,0.1);border-color:var(--red);color:var(--red);}
  .rc-expl{background:rgba(26,62,140,0.05);border-radius:9px;padding:9px 12px;font-size:0.82rem;color:var(--text-mid);border-left:3px solid var(--gold);line-height:1.55;}
  .rc-expl b{color:var(--blue);font-size:0.78rem;display:block;margin-bottom:3px;}

  /* LEADERBOARD */
  .lb-header{background:linear-gradient(135deg,var(--purple),var(--purple-light));padding:14px 16px;display:flex;align-items:center;gap:12px;color:#fff;}
  .lb-content{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;}
  .lb-card{background:#fff;border-radius:14px;padding:13px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 10px rgba(90,45,130,0.08);transition:transform 0.15s;}
  .lb-card:hover{transform:translateX(2px);}
  .lb-rank{width:36px;height:36px;border-radius:10px;font-family:'Poppins',sans-serif;font-weight:800;font-size:1rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .r1{background:linear-gradient(135deg,#C89B14,#FFD700);color:#fff;}
  .r2{background:linear-gradient(135deg,#888,#aaa);color:#fff;}
  .r3{background:linear-gradient(135deg,#C05020,#E07840);color:#fff;}
  .rn{background:#f0f0f0;color:var(--text-mid);}
  .lb-info{flex:1;}
  .lb-name{font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9rem;color:var(--text-dark);}
  .lb-meta{font-size:0.75rem;color:var(--text-mid);margin-top:2px;}
  .lb-score{font-family:'Poppins',sans-serif;font-weight:800;font-size:1.1rem;color:var(--purple);}
  .you-tag{font-size:0.65rem;font-weight:700;background:rgba(90,45,130,0.12);color:var(--purple);padding:2px 7px;border-radius:99px;margin-left:6px;}

  /* ANALYTICS */
  .ana-header{background:linear-gradient(135deg,var(--blue-dark),var(--blue));padding:14px 16px;display:flex;align-items:center;gap:12px;color:#fff;}
  .ana-content{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:14px;}
  .ana-card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(26,62,140,0.08);}
  .ana-title{font-family:'Poppins',sans-serif;font-weight:700;font-size:0.85rem;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:12px;}
  .big-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
  .ana-stat{background:var(--bg-light);border-radius:12px;padding:12px;text-align:center;}
  .ana-val{font-family:'Poppins',sans-serif;font-weight:800;font-size:1.5rem;color:var(--blue);}
  .ana-lbl{font-size:0.73rem;color:var(--text-mid);margin-top:2px;}
  .bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
  .bar-label{font-size:0.82rem;font-weight:600;width:72px;flex-shrink:0;}
  .bar-wrap{flex:1;height:10px;background:#eee;border-radius:99px;overflow:hidden;}
  .bar-fill{height:100%;border-radius:99px;transition:width 0.8s ease;}
  .bar-pct{font-size:0.78rem;font-weight:700;color:var(--text-mid);width:35px;text-align:right;}
  .hist-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #f0f0f0;}
  .hist-item:last-child{border-bottom:none;}
  .hist-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
  .hist-info{flex:1;}
  .hist-name{font-family:'Poppins',sans-serif;font-weight:600;font-size:0.85rem;}
  .hist-meta{font-size:0.72rem;color:var(--text-mid);margin-top:2px;}
  .hist-score{font-family:'Poppins',sans-serif;font-weight:800;font-size:1rem;}

  /* USER MODAL */
  .user-input{width:100%;padding:13px 16px;border:2px solid rgba(26,62,140,0.15);border-radius:12px;font-family:'Nunito',sans-serif;font-size:1rem;color:var(--text-dark);outline:none;transition:border-color 0.15s;margin-bottom:12px;}
  .user-input:focus{border-color:var(--blue);}
  .user-save-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--blue-dark),var(--blue));color:#fff;border:none;border-radius:12px;font-family:'Poppins',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;}

  /* DIALOG */
  .dialog-overlay{position:fixed;inset:0;z-index:400;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;}
  .dialog-box{background:#fff;border-radius:20px;padding:24px 22px;width:min(340px,90vw);box-shadow:0 12px 48px rgba(0,0,0,0.3);animation:dBoxIn 0.25s ease;}
  @keyframes dBoxIn{from{opacity:0;transform:scale(0.85)}to{opacity:1;transform:scale(1)}}
  .dialog-title{font-family:'Poppins',sans-serif;font-weight:700;font-size:1.1rem;margin-bottom:8px;}
  .dialog-body{font-size:0.9rem;color:var(--text-mid);margin-bottom:20px;line-height:1.5;}
  .dialog-actions{display:flex;gap:10px;}
  .dialog-btn{flex:1;padding:11px;border-radius:11px;border:none;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.15s;}
  .d-cancel{background:#f0f0f0;color:var(--text-dark);}
  .d-confirm{background:var(--red);color:#fff;}
  .dialog-btn:hover{transform:scale(1.03);}

  /* TOAST */
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#1E2240;color:#fff;padding:10px 20px;border-radius:12px;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.85rem;z-index:500;transition:transform 0.3s ease;white-space:nowrap;box-shadow:0 4px 24px rgba(0,0,0,0.4);}
  .toast.show{transform:translateX(-50%) translateY(0);}
  .toast.ok{border-left:4px solid var(--green-light);}
  .toast.err{border-left:4px solid var(--red);}

  /* UTILS */
  .hidden{display:none!important;}
  .empty{text-align:center;padding:40px 20px;color:var(--text-mid);}
  .empty-icon{font-size:3rem;margin-bottom:12px;}
  .empty-title{font-family:'Poppins',sans-serif;font-weight:600;font-size:1rem;color:var(--text-dark);margin-bottom:6px;}
  .empty-sub{font-size:0.85rem;}
  ::-webkit-scrollbar{width:5px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:rgba(200,155,20,0.3);border-radius:99px;}

  /* PYQ CARD */
  .card-pyq{background:linear-gradient(135deg,#1A3E8C,#8B5CF6);}

  /* PYQ HOME */
  .pyq-header{background:linear-gradient(135deg,#1A3E8C,#8B5CF6);padding:14px 16px;display:flex;align-items:center;gap:12px;color:#fff;}
  .pyq-home-content{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px;}
  .pyq-info-box{background:linear-gradient(135deg,rgba(26,62,140,0.08),rgba(139,92,246,0.08));border:2px solid rgba(139,92,246,0.2);border-radius:18px;padding:20px;text-align:center;}
  .pyq-info-icon{font-size:2.5rem;margin-bottom:8px;}
  .pyq-info-title{font-family:'Poppins',sans-serif;font-weight:700;font-size:1.1rem;color:var(--blue);margin-bottom:6px;}
  .pyq-info-sub{font-size:0.84rem;color:var(--text-mid);line-height:1.55;}
  .pyq-filters{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 12px rgba(26,62,140,0.08);}
  .pyq-filter-label{font-family:'Poppins',sans-serif;font-weight:700;font-size:0.8rem;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;}
  .pyq-year-grid{display:flex;flex-wrap:wrap;gap:8px;}
  .pyq-year-btn{padding:7px 14px;border-radius:10px;border:2px solid rgba(26,62,140,0.15);background:#f8f9fc;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.85rem;color:var(--text-mid);cursor:pointer;transition:all 0.15s;}
  .pyq-year-btn:hover,.pyq-year-btn.active{background:var(--blue);color:#fff;border-color:var(--blue);transform:scale(1.04);}
  .pyq-subject-btns{display:flex;gap:8px;flex-wrap:wrap;}
  .pyq-sub-btn{padding:7px 14px;border-radius:10px;border:2px solid rgba(26,62,140,0.15);background:#f8f9fc;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.82rem;color:var(--text-mid);cursor:pointer;transition:all 0.15s;}
  .pyq-sub-btn:hover,.pyq-sub-btn.active{background:linear-gradient(135deg,var(--blue-dark),var(--blue));color:#fff;border-color:var(--blue);transform:scale(1.04);}
  .pyq-start-btn{width:100%;padding:15px;background:linear-gradient(135deg,#1A3E8C,#8B5CF6);color:#fff;border:none;border-radius:14px;font-family:'Poppins',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;box-shadow:0 4px 20px rgba(139,92,246,0.35);transition:all 0.15s;}
  .pyq-start-btn:hover{transform:translateY(-2px);}
  .pyq-hint{text-align:center;font-size:0.78rem;color:var(--text-mid);opacity:0.7;}

  /* PYQ TIMER BAR */
  .pyq-timer-wrap{background:#1A1D35;padding:8px 16px 10px;border-bottom:1px solid rgba(200,155,20,0.1);}
  .pyq-timer-label{font-size:0.78rem;color:rgba(255,255,255,0.6);margin-bottom:5px;font-family:'Poppins',sans-serif;font-weight:600;text-align:center;}
  .pyq-timer-bar-bg{height:5px;background:rgba(255,255,255,0.1);border-radius:99px;overflow:hidden;}
  .pyq-timer-bar{height:100%;background:linear-gradient(90deg,var(--gold),#FFD700);border-radius:99px;width:100%;transition:width 1s linear;}
  .pyq-year-tag{font-size:0.72rem;color:var(--gold);font-weight:700;letter-spacing:0.06em;margin-bottom:4px;}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div style="position:relative;display:flex;align-items:center;justify-content:center;">
    <svg class="benzene-left" width="70" height="80" viewBox="0 0 70 80" fill="none">
      <polygon points="35,5 65,22.5 65,57.5 35,75 5,57.5 5,22.5" stroke="rgba(200,155,20,0.6)" stroke-width="2.5" fill="none"/>
      <line x1="35" y1="15" x2="35" y2="65" stroke="rgba(200,155,20,0.3)" stroke-width="1.5" stroke-dasharray="5,5"/>
      <line x1="15" y1="27" x2="55" y2="53" stroke="rgba(200,155,20,0.3)" stroke-width="1.5" stroke-dasharray="5,5"/>
      <line x1="55" y1="27" x2="15" y2="53" stroke="rgba(200,155,20,0.3)" stroke-width="1.5" stroke-dasharray="5,5"/>
    </svg>
    <div class="splash-atom">
      <div class="atom-nucleus"></div>
      <div class="orbit orbit-1"><div class="electron"></div></div>
      <div class="orbit orbit-2"><div class="electron"></div></div>
      <div class="orbit orbit-3"><div class="electron"></div></div>
    </div>
    <svg class="benzene-right" width="70" height="80" viewBox="0 0 70 80" fill="none">
      <polygon points="35,5 65,22.5 65,57.5 35,75 5,57.5 5,22.5" stroke="rgba(200,155,20,0.6)" stroke-width="2.5" fill="none"/>
      <line x1="35" y1="15" x2="35" y2="65" stroke="rgba(200,155,20,0.3)" stroke-width="1.5" stroke-dasharray="5,5"/>
      <line x1="15" y1="27" x2="55" y2="53" stroke="rgba(200,155,20,0.3)" stroke-width="1.5" stroke-dasharray="5,5"/>
      <line x1="55" y1="27" x2="15" y2="53" stroke="rgba(200,155,20,0.3)" stroke-width="1.5" stroke-dasharray="5,5"/>
    </svg>
  </div>
  <div class="splash-title">SCIENCE SIMPLIFIED<span class="splash-institute">INSTITUTE</span></div>
  <div class="splash-tagline">Simplify<span class="tagline-dot">.</span> Practice<span class="tagline-dot">.</span> Excel<span class="tagline-dot">.</span></div>
</div>

<!-- APP -->
<div id="app">
  <!-- HEADER -->
  <div class="header">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="logo-icon">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
          <circle cx="11" cy="11" r="4" fill="#C89B14"/>
          <ellipse cx="11" cy="11" rx="10" ry="4" stroke="#C89B14" stroke-width="1.5" fill="none"/>
          <ellipse cx="11" cy="11" rx="10" ry="4" stroke="#C89B14" stroke-width="1.5" fill="none" transform="rotate(60 11 11)"/>
          <ellipse cx="11" cy="11" rx="10" ry="4" stroke="#C89B14" stroke-width="1.5" fill="none" transform="rotate(120 11 11)"/>
        </svg>
      </div>
      <div class="logo-text">Science Simplified<span>Institute</span></div>
    </div>
    <div class="header-right">
      <div class="header-greeting" id="greeting">Good Morning! üëã</div>
      <button class="user-btn" id="user-btn" onclick="openUserModal()">üë§ Set Name</button>
    </div>
  </div>

  <!-- HOME -->
  <div class="screen active" id="screen-home">
    <div class="home-hero">
      <h1>What do you want to<br>practice today?</h1>
      <p>NEET MCQ ¬∑ Chapter-wise ¬∑ Levels ¬∑ Supabase powered</p>
    </div>
    <div class="subject-grid">
      <div class="subject-card card-physics" onclick="openSubject('physics')">
        <div class="card-icon">‚öõÔ∏è</div><div class="card-name poppins">Physics</div>
        <div class="card-meta">30 chapters ¬∑ 850+ questions</div>
      </div>
      <div class="subject-card card-biology" onclick="openSubject('biology')">
        <div class="card-icon">üß¨</div><div class="card-name poppins">Biology</div>
        <div class="card-meta">38 chapters ¬∑ 1200+ questions</div>
      </div>
      <div class="subject-card card-chemistry" onclick="openSubject('chemistry')">
        <div class="card-icon">üß™</div><div class="card-name poppins">Chemistry</div>
        <div class="card-meta">34 chapters ¬∑ 950+ questions</div>
      </div>
      <div class="subject-card card-pyq" onclick="openPYQ()">
        <div class="card-icon">üìÖ</div><div class="card-name poppins">PYQ Attempt</div>
        <div class="card-meta">Previous Year Questions ¬∑ Attempt Mode</div>
      </div>
      <div class="subject-card card-lb" onclick="openLeaderboard()">
        <div class="card-icon">üèÜ</div><div class="card-name poppins">Leaderboard</div>
        <div class="card-meta">Live rankings ¬∑ Top scorers</div>
      </div>
      <div class="subject-card card-ana" onclick="openAnalytics()">
        <div class="card-icon">üìä</div><div class="card-name poppins">My Progress</div>
        <div class="card-meta">History ¬∑ Stats ¬∑ Analytics</div>
      </div>
    </div>
    <div style="padding:0 16px 24px;text-align:center;color:var(--text-mid);font-size:0.78rem;opacity:0.7;">
      NEET marking: +4 correct ¬∑ ‚àí1 wrong ¬∑ Progress saved to Supabase
    </div>
  </div>

  <!-- TOPICS -->
  <div class="screen" id="screen-topics">
    <div class="topic-header">
      <button class="back-btn" onclick="goHome()">‚Üê Back</button>
      <div class="topic-header-title" id="topic-subject-name">Physics</div>
      <span id="topic-icon" style="font-size:1.5rem;">‚öõÔ∏è</span>
    </div>
    <div class="tab-bar">
      <button class="tab-btn active" id="tab-11" onclick="switchTab(11)">Class 11</button>
      <button class="tab-btn" id="tab-12" onclick="switchTab(12)">Class 12</button>
    </div>
    <div class="chapter-list" id="chapter-list"></div>
  </div>

  <!-- LOADING -->
  <div class="screen" id="screen-loading">
    <div class="loading-screen">
      <div class="loading-badge">üóÑÔ∏è Supabase</div>
      <div class="spinner"></div>
      <div class="loading-text" id="loading-text">Fetching questions‚Ä¶</div>
      <div class="loading-sub" id="loading-sub">Loading from database</div>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="screen quiz-screen" id="screen-quiz">
    <div class="quiz-topbar">
      <button class="back-btn" onclick="exitQuiz()" style="background:rgba(255,255,255,0.1);">‚úï Exit</button>
      <div class="quiz-title" id="quiz-title">Chapter</div>
      <div class="level-pill pill-basic" id="level-pill">Basic</div>
      <div class="score-pill" id="score-pill">Score: 0</div>
    </div>
    <div class="quiz-progress-wrap">
      <div class="quiz-progress-bar"><div class="quiz-progress-fill" id="quiz-progress" style="width:0%"></div></div>
      <div class="quiz-counter" id="quiz-counter">Q 1 / 8</div>
    </div>
    <div class="quiz-content" id="quiz-content"></div>
  </div>

  <!-- RESULTS -->
  <div class="screen results-screen" id="screen-results">
    <div class="quiz-topbar" style="background:#16192E;">
      <div style="flex:1;text-align:center;font-family:'Poppins',sans-serif;font-weight:700;color:#fff;font-size:1rem;">Quiz Complete! üéâ</div>
    </div>
    <div class="results-content">
      <div class="score-ring-wrap">
        <svg class="score-ring-svg" viewBox="0 0 176 176" fill="none">
          <circle cx="88" cy="88" r="80" stroke="rgba(200,155,20,0.15)" stroke-width="8"/>
          <circle cx="88" cy="88" r="80" stroke="url(#rg)" stroke-width="8" stroke-dasharray="502" id="score-arc" stroke-dashoffset="502" stroke-linecap="round" transform="rotate(-90 88 88)" style="transition:stroke-dashoffset 1.2s ease"/>
          <defs><linearGradient id="rg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#C89B14"/><stop offset="100%" stop-color="#FFD700"/></linearGradient></defs>
        </svg>
        <div class="score-big" id="score-display">0</div>
        <div class="score-lbl">NEET Score</div>
      </div>
      <div class="perf-badge" id="perf-badge">üèÜ Excellent!</div>
      <div class="stats-grid">
        <div class="stat-box g"><div class="stat-val" id="r-correct">0</div><div class="stat-lbl">‚úÖ Correct</div></div>
        <div class="stat-box r"><div class="stat-val" id="r-wrong">0</div><div class="stat-lbl">‚ùå Wrong</div></div>
        <div class="stat-box"><div class="stat-val" id="r-skip">0</div><div class="stat-lbl">‚è≠Ô∏è Skipped</div></div>
        <div class="stat-box gold"><div class="stat-val" id="r-total">0</div><div class="stat-lbl">üìã Total</div></div>
      </div>
      <div class="neet-box">
        <div class="neet-lbl">NEET Score (+4/‚àí1)</div>
        <div class="neet-val" id="r-neet">0</div>
        <div class="neet-max" id="r-max">/ 0 maximum</div>
      </div>
      <div class="save-status" id="save-status">üíæ Saving to Supabase‚Ä¶</div>
      <div class="result-btns" id="result-btns-wrap">
        <button class="result-btn primary" onclick="retryChapter()">üîÑ Retry Chapter</button>
        <button class="result-btn secondary" onclick="reviewAnswers()">üìñ Review Answers</button>
        <button class="result-btn secondary" onclick="goTopics()">üìö Choose Another Chapter</button>
        <button class="result-btn secondary" onclick="openLeaderboard()">üèÜ View Leaderboard</button>
      </div>
    </div>
  </div>

  <!-- REVIEW -->
  <div class="screen" id="screen-review">
    <div class="review-header">
      <button class="back-btn" onclick="showScreen('results')">‚Üê Back</button>
      <div style="flex:1;text-align:center;font-family:'Poppins',sans-serif;font-weight:700;font-size:1rem;">Answer Review</div>
    </div>
    <div class="review-list" id="review-list"></div>
  </div>

  <!-- LEADERBOARD -->
  <div class="screen" id="screen-leaderboard">
    <div class="lb-header">
      <button class="back-btn" onclick="goHome()">‚Üê Back</button>
      <div class="topic-header-title">üèÜ Leaderboard</div>
      <button onclick="loadLeaderboard()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:600;white-space:nowrap;">‚Üª Refresh</button>
    </div>
    <div class="lb-content" id="lb-content"></div>
  </div>

  <!-- ANALYTICS -->
  <div class="screen" id="screen-analytics">
    <div class="ana-header">
      <button class="back-btn" onclick="goHome()">‚Üê Back</button>
      <div class="topic-header-title">üìä My Progress</div>
    </div>
    <div class="ana-content" id="ana-content"></div>
  </div>

  <!-- PYQ HOME -->
  <div class="screen" id="screen-pyq">
    <div class="pyq-header">
      <button class="back-btn" onclick="goHome()">‚Üê Back</button>
      <div class="topic-header-title">üìÖ PYQ Attempt Mode</div>
    </div>
    <div class="pyq-home-content">
      <div class="pyq-info-box">
        <div class="pyq-info-icon">üéØ</div>
        <div class="pyq-info-title">Previous Year Questions</div>
        <div class="pyq-info-sub">Real NEET questions from past papers. Answer and the next question auto-loads after 10 seconds. NEET scoring applies: +4 / ‚àí1.</div>
      </div>
      <div class="pyq-filters">
        <div class="pyq-filter-label">Select Year</div>
        <div class="pyq-year-grid" id="pyq-year-grid">
          <!-- rendered by JS -->
        </div>
        <div class="pyq-filter-label" style="margin-top:14px">Select Subject</div>
        <div class="pyq-subject-btns">
          <button class="pyq-sub-btn active" id="pyq-sub-all" onclick="setPYQSubject('all')">All</button>
          <button class="pyq-sub-btn" id="pyq-sub-physics" onclick="setPYQSubject('physics')">‚öõÔ∏è Physics</button>
          <button class="pyq-sub-btn" id="pyq-sub-biology" onclick="setPYQSubject('biology')">üß¨ Biology</button>
          <button class="pyq-sub-btn" id="pyq-sub-chemistry" onclick="setPYQSubject('chemistry')">üß™ Chemistry</button>
        </div>
      </div>
      <button class="pyq-start-btn" onclick="startPYQAttempt()">üöÄ Start Attempt Mode</button>
      <div class="pyq-hint">üí° Auto-advances to next question after 10s once answered</div>
    </div>
  </div>

  <!-- PYQ QUIZ -->
  <div class="screen quiz-screen" id="screen-pyq-quiz">
    <div class="quiz-topbar">
      <button class="back-btn" onclick="exitPYQQuiz()" style="background:rgba(255,255,255,0.1);">‚úï Exit</button>
      <div class="quiz-title" id="pyq-quiz-title">NEET PYQ</div>
      <div class="level-pill" id="pyq-year-pill" style="background:rgba(200,155,20,0.2);color:var(--gold)">2023</div>
      <div class="score-pill" id="pyq-score-pill">Score: 0</div>
    </div>
    <div class="quiz-progress-wrap">
      <div class="quiz-progress-bar"><div class="quiz-progress-fill" id="pyq-quiz-progress" style="width:0%"></div></div>
      <div class="quiz-counter" id="pyq-quiz-counter">Q 1 / 20</div>
    </div>
    <!-- Auto-next timer bar -->
    <div id="pyq-timer-wrap" class="pyq-timer-wrap hidden">
      <div class="pyq-timer-label">Next question in <span id="pyq-timer-sec">10</span>s</div>
      <div class="pyq-timer-bar-bg"><div class="pyq-timer-bar" id="pyq-timer-bar"></div></div>
    </div>
    <div class="quiz-content" id="pyq-quiz-content"></div>
  </div>
</div>

<!-- LEVEL MODAL -->
<div class="modal-overlay hidden" id="level-modal" onclick="if(event.target===this)closeLevelModal()">
  <div class="bottom-sheet">
    <div class="sheet-title">Choose Difficulty</div>
    <div class="sheet-sub" id="level-modal-sub">Chapter ¬∑ Subject</div>
    <div class="level-cards">
      <div class="level-card level-basic" onclick="startQuizWithLevel('basic')">
        <div class="level-icon">üü¢</div>
        <div><div class="level-name">Basic</div><div class="level-desc">Direct recall, NCERT definitions, fundamentals</div></div>
      </div>
      <div class="level-card level-inter" onclick="startQuizWithLevel('intermediate')">
        <div class="level-icon">üü°</div>
        <div><div class="level-name">Intermediate</div><div class="level-desc">Application-based, moderate numericals</div></div>
      </div>
      <div class="level-card level-adv" onclick="startQuizWithLevel('advanced')">
        <div class="level-icon">üî¥</div>
        <div><div class="level-name">Advanced</div><div class="level-desc">NEET-level tricky, multi-concept problems</div></div>
      </div>
    </div>
    <button class="sheet-cancel" onclick="closeLevelModal()">Cancel</button>
  </div>
</div>

<!-- USER MODAL -->
<div class="modal-overlay hidden" id="user-modal" onclick="if(event.target===this)closeUserModal()">
  <div class="bottom-sheet">
    <div class="sheet-title">Your Profile</div>
    <div class="sheet-sub">Set your name to appear on the leaderboard</div>
    <input class="user-input" id="username-input" type="text" placeholder="Enter your name‚Ä¶" maxlength="30"/>
    <button class="user-save-btn" onclick="saveUsername()">Save &amp; Continue</button>
  </div>
</div>

<!-- EXIT DIALOG -->
<div class="dialog-overlay hidden" id="dialog">
  <div class="dialog-box">
    <div class="dialog-title">Exit Quiz?</div>
    <div class="dialog-body">Your progress for this session will be lost.</div>
    <div class="dialog-actions">
      <button class="dialog-btn d-cancel" onclick="closeDialog()">Cancel</button>
      <button class="dialog-btn d-confirm" onclick="confirmExit()">Exit</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPABASE_URL = 'https://lfgtrbwlhnfwpunoixxi.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmZ3RyYndsaG5md3B1bm9peHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MDY2MTIsImV4cCI6MjA4Njk4MjYxMn0.U11nGQcc6lDazLUkL2DrO9yKUm5XJq9UOrko40MfLik';

const SB_HEADERS = {
  'apikey': SUPABASE_KEY,
  'Authorization': 'Bearer ' + SUPABASE_KEY,
  'Content-Type': 'application/json',
  'Prefer': 'return=representation'
};

async function sbGet(table, query = '') {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, { headers: SB_HEADERS });
  if (!r.ok) throw new Error(`GET ${table}: ${await r.text()}`);
  return r.json();
}

async function sbPost(table, body) {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, { method:'POST', headers: SB_HEADERS, body: JSON.stringify(body) });
  if (!r.ok) throw new Error(`POST ${table}: ${await r.text()}`);
  return r.json();
}

async function sbPatch(table, query, body) {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, { method:'PATCH', headers: SB_HEADERS, body: JSON.stringify(body) });
  if (!r.ok) throw new Error(`PATCH ${table}: ${await r.text()}`);
  return r.json();
}

// ============================================================
// CHAPTER DATA
// ============================================================
const DATA = {
  physics:{icon:'‚öõÔ∏è',chapters:{
    11:[
      {name:'Physical World and Measurement',qs:18,done:0},{name:'Kinematics',qs:45,done:0},
      {name:'Laws of Motion',qs:38,done:0},{name:'Work, Energy and Power',qs:42,done:0},
      {name:'Motion of System of Particles',qs:28,done:0},{name:'Gravitation',qs:35,done:0},
      {name:'Properties of Bulk Matter',qs:30,done:0},{name:'Thermodynamics',qs:40,done:0},
      {name:'Behaviour of Perfect Gas',qs:25,done:0},{name:'Oscillations and Waves',qs:48,done:0},
    ],
    12:[
      {name:'Electrostatics',qs:55,done:0},{name:'Current Electricity',qs:50,done:0},
      {name:'Magnetic Effects of Current',qs:45,done:0},{name:'Magnetism and Matter',qs:30,done:0},
      {name:'Electromagnetic Induction',qs:38,done:0},{name:'Alternating Current',qs:35,done:0},
      {name:'Electromagnetic Waves',qs:22,done:0},{name:'Ray Optics',qs:52,done:0},
      {name:'Wave Optics',qs:32,done:0},{name:'Dual Nature of Matter',qs:28,done:0},
      {name:'Atoms and Nuclei',qs:40,done:0},{name:'Electronic Devices',qs:35,done:0},
    ]
  }},
  biology:{icon:'üß¨',chapters:{
    11:[
      {name:'The Living World',qs:22,done:0},{name:'Biological Classification',qs:40,done:0},
      {name:'Plant Kingdom',qs:35,done:0},{name:'Animal Kingdom',qs:45,done:0},
      {name:'Morphology of Flowering Plants',qs:38,done:0},{name:'Anatomy of Flowering Plants',qs:30,done:0},
      {name:'Structural Organisation in Animals',qs:28,done:0},{name:'Cell: The Unit of Life',qs:42,done:0},
      {name:'Biomolecules',qs:48,done:0},{name:'Cell Cycle and Cell Division',qs:35,done:0},
      {name:'Transport in Plants',qs:25,done:0},{name:'Mineral Nutrition',qs:28,done:0},
      {name:'Photosynthesis in Higher Plants',qs:50,done:0},{name:'Respiration in Plants',qs:35,done:0},
      {name:'Plant Growth and Development',qs:30,done:0},{name:'Digestion and Absorption',qs:38,done:0},
      {name:'Breathing and Exchange of Gases',qs:32,done:0},{name:'Body Fluids and Circulation',qs:40,done:0},
      {name:'Excretory Products and Elimination',qs:38,done:0},{name:'Locomotion and Movement',qs:35,done:0},
      {name:'Neural Control and Coordination',qs:45,done:0},{name:'Chemical Coordination',qs:40,done:0},
    ],
    12:[
      {name:'Reproduction in Organisms',qs:25,done:0},{name:'Sexual Reproduction in Flowering Plants',qs:45,done:0},
      {name:'Human Reproduction',qs:40,done:0},{name:'Reproductive Health',qs:28,done:0},
      {name:'Principles of Inheritance',qs:55,done:0},{name:'Molecular Basis of Inheritance',qs:60,done:0},
      {name:'Evolution',qs:42,done:0},{name:'Human Health and Disease',qs:50,done:0},
      {name:'Strategies for Enhancement in Food Production',qs:30,done:0},{name:'Microbes in Human Welfare',qs:35,done:0},
      {name:'Biotechnology: Principles and Processes',qs:45,done:0},{name:'Biotechnology and its Applications',qs:40,done:0},
      {name:'Organisms and Populations',qs:35,done:0},{name:'Ecosystem',qs:38,done:0},
      {name:'Biodiversity and Conservation',qs:30,done:0},{name:'Environmental Issues',qs:25,done:0},
    ]
  }},
  chemistry:{icon:'üß™',chapters:{
    11:[
      {name:'Some Basic Concepts of Chemistry',qs:35,done:0},{name:'Structure of Atom',qs:42,done:0},
      {name:'Classification of Elements',qs:38,done:0},{name:'Chemical Bonding and Molecular Structure',qs:55,done:0},
      {name:'States of Matter',qs:30,done:0},{name:'Thermodynamics',qs:40,done:0},
      {name:'Equilibrium',qs:50,done:0},{name:'Redox Reactions',qs:28,done:0},
      {name:'Hydrogen',qs:20,done:0},{name:'s-Block Elements',qs:32,done:0},
      {name:'p-Block Elements (Group 13 & 14)',qs:38,done:0},{name:'Organic Chemistry ‚Äì Basic Principles',qs:45,done:0},
      {name:'Hydrocarbons',qs:42,done:0},{name:'Environmental Chemistry',qs:18,done:0},
    ],
    12:[
      {name:'The Solid State',qs:35,done:0},{name:'Solutions',qs:40,done:0},
      {name:'Electrochemistry',qs:45,done:0},{name:'Chemical Kinetics',qs:38,done:0},
      {name:'Surface Chemistry',qs:28,done:0},{name:'d and f Block Elements',qs:42,done:0},
      {name:'Coordination Compounds',qs:50,done:0},{name:'Haloalkanes and Haloarenes',qs:38,done:0},
      {name:'Alcohols, Phenols and Ethers',qs:42,done:0},{name:'Aldehydes, Ketones and Carboxylic Acids',qs:50,done:0},
      {name:'Amines',qs:35,done:0},{name:'Biomolecules',qs:30,done:0},
      {name:'Polymers',qs:25,done:0},{name:'Chemistry in Everyday Life',qs:22,done:0},
    ]
  }}
};

// ============================================================
// FALLBACK QUESTIONS (used when DB has no questions for a chapter/level)
// ============================================================
const FALLBACK = {
  physics:[
    {q:"Newton's first law of motion gives the concept of:",opts:["Energy","Work","Inertia","Momentum"],ans:2,expl:"Newton's first law: a body continues in its state unless acted upon by external force ‚Äî this property is inertia."},
    {q:"Escape velocity from Earth's surface is approximately:",opts:["7.9 km/s","11.2 km/s","6.4 km/s","9.8 km/s"],ans:1,expl:"Escape velocity = ‚àö(2gR) ‚âà 11.2 km/s where g=9.8 m/s¬≤, R=6400 km."},
    {q:"SI unit of electric flux is:",opts:["N/C","N¬∑m¬≤/C","C/m¬≤","V/m"],ans:1,expl:"Œ¶ = E¬∑A¬∑cosŒ∏ ‚Üí SI unit is N¬∑m¬≤/C (also V¬∑m)."},
    {q:"Ohm's law (V=IR) is valid for:",opts:["Semiconductors only","Metallic conductors at constant temperature","All materials","Electrolytes only"],ans:1,expl:"Ohm's law is valid for metallic conductors at constant temperature where resistance is constant."},
    {q:"A particle in circular motion of radius r with speed v. Change in velocity after half revolution:",opts:["Zero","2v","v/2","œÄv"],ans:1,expl:"After half revolution velocity reverses: Œîv = v‚àí(‚àív) = 2v."},
    {q:"In Young's double slit experiment slit separation doubled. Fringe width will:",opts:["Remain same","Become half","Become double","Become four times"],ans:1,expl:"Œ≤ = ŒªD/d. If d doubles, Œ≤ halves."},
    {q:"Half-life of radioactive substance is 30 min. After 90 min, fraction remaining is:",opts:["1/2","1/4","1/8","1/16"],ans:2,expl:"90 min = 3 half-lives ‚Üí (1/2)¬≥ = 1/8."},
    {q:"Energy stored in a capacitor of capacitance C charged to voltage V is:",opts:["CV","¬ΩCV¬≤","CV¬≤","2CV¬≤"],ans:1,expl:"Energy stored = ¬ΩCV¬≤."},
  ],
  biology:[
    {q:"Glucose breakdown without oxygen is called:",opts:["Aerobic respiration","Fermentation","Photosynthesis","Transpiration"],ans:1,expl:"Fermentation (anaerobic) breaks down glucose without oxygen."},
    {q:"'Powerhouse of the cell' is:",opts:["Ribosome","Lysosome","Mitochondria","Golgi apparatus"],ans:2,expl:"Mitochondria produce ATP via oxidative phosphorylation."},
    {q:"DNA replication is semiconservative because:",opts:["Only one strand synthesised","Each daughter DNA has one old and one new strand","Both strands are new","DNA replicates twice"],ans:1,expl:"Meselson-Stahl proved each daughter DNA retains one parental strand."},
    {q:"Universal donor blood group is:",opts:["A","B","AB","O"],ans:3,expl:"Blood group O lacks A and B antigens, minimising rejection."},
    {q:"Functional unit of kidney is:",opts:["Nephron","Neuron","Villus","Glomerulus"],ans:0,expl:"The nephron is the structural and functional unit of the kidney."},
    {q:"Fight or flight response hormone:",opts:["Insulin","Thyroxine","Adrenaline","Glucagon"],ans:2,expl:"Adrenaline (epinephrine) from adrenal medulla triggers fight-or-flight."},
    {q:"Light reactions of photosynthesis occur in:",opts:["Stroma","Grana (thylakoid membranes)","Cytosol","Nucleus"],ans:1,expl:"Light reactions occur in thylakoid membranes (grana) of chloroplasts."},
    {q:"Law of segregation was proposed by:",opts:["Darwin","Lamarck","Mendel","Morgan"],ans:2,expl:"Gregor Mendel proposed the Law of Segregation."},
  ],
  chemistry:[
    {q:"Hybridisation of carbon in CH‚ÇÑ is:",opts:["sp","sp¬≤","sp¬≥","sp¬≥d"],ans:2,expl:"CH‚ÇÑ: sp¬≥ hybridisation, tetrahedral geometry, bond angle 109.5¬∞."},
    {q:"Highest electronegativity among elements:",opts:["Oxygen","Nitrogen","Fluorine","Chlorine"],ans:2,expl:"Fluorine has highest electronegativity (3.98 on Pauling scale)."},
    {q:"Rate constant of first-order reaction has units:",opts:["mol¬∑L‚Åª¬π¬∑s‚Åª¬π","L¬∑mol‚Åª¬π¬∑s‚Åª¬π","s‚Åª¬π","mol¬∑L‚Åª¬π"],ans:2,expl:"For first-order: k = rate/[A] = s‚Åª¬π."},
    {q:"Oxidation number of Mn in KMnO‚ÇÑ:",opts:["+5","+6","+7","+4"],ans:2,expl:"+1+x+4(‚àí2)=0 ‚Üí x=+7."},
    {q:"Avogadro's law: equal volumes of gases at same T and P contain:",opts:["Same mass","Same number of molecules","Same number of atoms","Same density"],ans:1,expl:"Avogadro: equal volumes ‚Üí equal number of molecules."},
    {q:"IUPAC name of CH‚ÇÉ-CH(OH)-CH‚ÇÉ:",opts:["1-propanol","2-propanol","Propanal","Propanone"],ans:1,expl:"OH on 2nd carbon of propane ‚Üí propan-2-ol (2-propanol)."},
    {q:"Esterification is reaction between:",opts:["Acid + Base","Carboxylic acid + Alcohol","Alcohol + Base","Aldehyde + Alcohol"],ans:1,expl:"Esterification: carboxylic acid + alcohol ‚Üí ester + water."},
    {q:"Which is a lyophilic colloid?",opts:["Gold sol","Starch sol","Arsenic sulphide sol","Ferric hydroxide sol"],ans:1,expl:"Starch sol is lyophilic (solvent-loving), stable and reversible."},
  ]
};

// ============================================================
// APP STATE
// ============================================================
let currentSubject = null;
let currentTab = 11;
let currentChapterName = '';
let currentChapterIndex = 0;
let currentLevel = 'basic';
let currentQuestions = [];
let currentQIndex = 0;
let score = 0, correctCount = 0, wrongCount = 0, skipCount = 0;
let userAnswers = [];

// User identity (persisted in localStorage)
let userId = localStorage.getItem('ss_uid') || (() => { const id='u_'+Math.random().toString(36).substr(2,12); localStorage.setItem('ss_uid',id); return id; })();
let username = localStorage.getItem('ss_uname') || '';

// ============================================================
// SPLASH + INIT
// ============================================================
window.addEventListener('load', () => {
  const h = new Date().getHours();
  document.getElementById('greeting').textContent = h<12?'Good Morning! üëã':h<17?'Good Afternoon! üëã':'Good Evening! üëã';
  updateUserBtn();
  setTimeout(() => {
    const s = document.getElementById('splash');
    s.classList.add('fade-out');
    setTimeout(() => { s.remove(); document.getElementById('app').classList.add('visible'); if(!username) setTimeout(openUserModal,800); }, 400);
  }, 2900);
});

// ============================================================
// USER PROFILE
// ============================================================
function updateUserBtn() {
  document.getElementById('user-btn').textContent = username ? `üë§ ${username}` : 'üë§ Set Name';
}
function openUserModal() {
  document.getElementById('username-input').value = username || '';
  document.getElementById('user-modal').classList.remove('hidden');
}
function closeUserModal() { document.getElementById('user-modal').classList.add('hidden'); }
function saveUsername() {
  const v = document.getElementById('username-input').value.trim();
  if (!v) { showToast('Please enter a name','err'); return; }
  username = v; localStorage.setItem('ss_uname', username);
  updateUserBtn(); closeUserModal(); showToast('‚úÖ Name saved!','ok');
}

// ============================================================
// NAVIGATION
// ============================================================
function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById('screen-'+id).classList.add('active'); }
function goHome() { showScreen('home'); }
function goTopics() { showScreen('topics'); }

function openSubject(sub) {
  currentSubject = sub;
  document.getElementById('topic-subject-name').textContent = sub.charAt(0).toUpperCase()+sub.slice(1);
  document.getElementById('topic-icon').textContent = DATA[sub].icon;
  currentTab = 11;
  document.getElementById('tab-11').classList.add('active');
  document.getElementById('tab-12').classList.remove('active');
  renderChapters();
  showScreen('topics');
}

function switchTab(cls) {
  currentTab = cls;
  document.getElementById('tab-11').classList.toggle('active', cls===11);
  document.getElementById('tab-12').classList.toggle('active', cls===12);
  renderChapters();
}

function renderChapters() {
  const chs = DATA[currentSubject].chapters[currentTab];
  const col = {physics:'#1A3E8C',biology:'#1A6B3C',chemistry:'#7A2A0A'}[currentSubject];
  document.getElementById('chapter-list').innerHTML = chs.map((ch,i) => {
    const pct = Math.round((ch.done/ch.qs)*100);
    return `<div class="chapter-card" style="border-left-color:${col}">
      <div class="chapter-num" style="background:linear-gradient(135deg,${col}dd,${col}99)">${i+1}</div>
      <div class="chapter-info">
        <div class="chapter-name">${ch.name}</div>
        <div class="chapter-sub">${ch.qs} questions ¬∑ Basic / Intermediate / Advanced</div>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
      </div>
      <button class="start-btn" onclick="openLevelModal(${i},'${ch.name.replace(/'/g,"\\'")}')">Start ‚Üó</button>
    </div>`;
  }).join('');
}

// ============================================================
// LEVEL MODAL
// ============================================================
function openLevelModal(idx, name) {
  currentChapterIndex = idx; currentChapterName = name;
  document.getElementById('level-modal-sub').textContent = `${name} ¬∑ ${currentSubject.charAt(0).toUpperCase()+currentSubject.slice(1)}`;
  document.getElementById('level-modal').classList.remove('hidden');
}
function closeLevelModal() { document.getElementById('level-modal').classList.add('hidden'); }

// ============================================================
// QUIZ FLOW
// ============================================================
async function startQuizWithLevel(level) {
  closeLevelModal(); currentLevel = level;
  document.getElementById('loading-text').textContent = `Loading ${level} questions‚Ä¶`;
  document.getElementById('loading-sub').textContent = currentChapterName;
  showScreen('loading');

  let qs = await fetchFromDB(currentSubject, currentChapterName, level);
  if (!qs || qs.length === 0) {
    qs = shuffle([...FALLBACK[currentSubject]]).slice(0,8).map(q=>({...q,level}));
    showToast('üí° Sample questions loaded ‚Äî add yours to Supabase!','ok');
  }

  currentQuestions = qs; currentQIndex = 0;
  score = 0; correctCount = 0; wrongCount = 0; skipCount = 0;
  userAnswers = new Array(qs.length).fill(null);

  const pillCls = {basic:'pill-basic',intermediate:'pill-inter',advanced:'pill-adv'}[level];
  document.getElementById('quiz-title').textContent = currentChapterName;
  const pill = document.getElementById('level-pill');
  pill.textContent = level.charAt(0).toUpperCase()+level.slice(1);
  pill.className = 'level-pill '+pillCls;
  document.getElementById('score-pill').textContent = 'Score: 0';
  renderQ(); showScreen('quiz');
}

async function fetchFromDB(subject, chapter, level) {
  try {
    const enc = encodeURIComponent(chapter);
    const data = await sbGet('questions', `?subject=eq.${subject}&chapter=eq.${enc}&level=eq.${level}&limit=20`);
    return shuffle(data).slice(0, Math.min(10, data.length));
  } catch(e) { console.warn('DB fetch failed:', e.message); return null; }
}

function shuffle(a) {
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;
}

function renderQ() {
  const q = currentQuestions[currentQIndex];
  const L = ['A','B','C','D'];
  const pct = (currentQIndex/currentQuestions.length)*100;
  document.getElementById('quiz-progress').style.width = pct+'%';
  document.getElementById('quiz-counter').textContent = `Q ${currentQIndex+1} / ${currentQuestions.length}`;
  document.getElementById('quiz-content').innerHTML = `
    <div class="question-card">
      <div class="q-num">QUESTION ${currentQIndex+1}</div>
      <div class="q-text">${q.q}</div>
    </div>
    <div class="options-list" id="opts">
      ${q.opts.map((o,i)=>`<button class="opt-btn" id="o${i}" onclick="pick(${i})"><div class="opt-letter">${L[i]}</div><div class="opt-text">${o}</div></button>`).join('')}
    </div>
    <div id="fb"></div>`;
}

function pick(sel) {
  const q = currentQuestions[currentQIndex];
  const L = ['A','B','C','D'];
  userAnswers[currentQIndex] = sel;
  document.querySelectorAll('.opt-btn').forEach(b=>b.disabled=true);
  const ok = sel === q.ans;
  document.getElementById('o'+sel).classList.add(ok?'correct':'wrong');
  document.getElementById('o'+sel).querySelector('.opt-letter').textContent = ok?'‚úì':'‚úó';
  if (!ok) { document.getElementById('o'+q.ans).classList.add('revealed'); document.getElementById('o'+q.ans).querySelector('.opt-letter').textContent='‚úì'; }
  if (ok){score+=4;correctCount++;}else{score-=1;wrongCount++;}
  document.getElementById('score-pill').textContent = `Score: ${score}`;
  const pill = document.getElementById('score-pill');
  pill.classList.remove('pop','shake'); void pill.offsetWidth; pill.classList.add(ok?'pop':'shake');
  document.getElementById('fb').innerHTML = `
    <div class="feedback ${ok?'correct':'wrong'}">${ok?'‚úÖ Correct! +4 points':`‚ùå Wrong! ‚àí1 pt ¬∑ Correct: (${L[q.ans]}) ${q.opts[q.ans]}`}</div>
    <div class="expl-box"><div class="expl-label">üìò NCERT EXPLANATION</div><div class="expl-text">${q.expl}</div></div>
    <button class="next-btn" onclick="nextQ()">${currentQIndex<currentQuestions.length-1?'Next Question ‚Üí':'üìä See Results'}</button>`;
}

function nextQ() {
  if (currentQIndex < currentQuestions.length-1){currentQIndex++;renderQ();}
  else showResults();
}

// ============================================================
// RESULTS
// ============================================================
async function showResults() {
  const total = currentQuestions.length;
  skipCount = userAnswers.filter(a=>a===null).length;
  const ns = (correctCount*4)-(wrongCount*1);
  const maxNs = total*4;
  const pct = Math.round((correctCount/total)*100);

  document.getElementById('r-correct').textContent = correctCount;
  document.getElementById('r-wrong').textContent = wrongCount;
  document.getElementById('r-skip').textContent = skipCount;
  document.getElementById('r-total').textContent = total;
  document.getElementById('r-neet').textContent = ns;
  document.getElementById('r-max').textContent = `/ ${maxNs} maximum`;

  const b = document.getElementById('perf-badge'); b.className='perf-badge';
  if(pct>=80){b.classList.add('perf-excellent');b.textContent='üèÜ Excellent!';}
  else if(pct>=50){b.classList.add('perf-good');b.textContent='üëç Good Job!';}
  else{b.classList.add('perf-practice');b.textContent='üìö Keep Practising';}

  // Reset result buttons for regular quiz context
  document.getElementById('result-btns-wrap').innerHTML = `
    <button class="result-btn primary" onclick="retryChapter()">üîÑ Retry Chapter</button>
    <button class="result-btn secondary" onclick="reviewAnswers()">üìñ Review Answers</button>
    <button class="result-btn secondary" onclick="goTopics()">üìö Choose Another Chapter</button>
    <button class="result-btn secondary" onclick="openLeaderboard()">üèÜ View Leaderboard</button>`;

  showScreen('results');

  // Animate score
  let cur=0; const el=document.getElementById('score-display');
  const step=Math.ceil(Math.abs(ns)/40)||1;
  const iv=setInterval(()=>{if(Math.abs(cur-ns)<=step){cur=ns;clearInterval(iv);}else cur+=(ns>0?step:-step);el.textContent=cur;},28);
  setTimeout(()=>{document.getElementById('score-arc').style.strokeDashoffset=502*(1-pct/100);},100);

  // Save to Supabase
  document.getElementById('save-status').textContent='üíæ Saving to Supabase‚Ä¶';
  try {
    await sbPost('progress',{user_id:userId,subject:currentSubject,chapter:currentChapterName,level:currentLevel,correct:correctCount,wrong:wrongCount,skipped:skipCount,neet_score:ns});
    await updateLeaderboard(ns);
    document.getElementById('save-status').textContent='‚úÖ Saved to Supabase!';
  } catch(e) {
    document.getElementById('save-status').textContent='‚ö†Ô∏è Could not save (offline?)';
  }
}

async function updateLeaderboard(ns) {
  if (!username) return;
  try {
    const ex = await sbGet('leaderboard',`?user_id=eq.${userId}&limit=1`);
    if (ex && ex.length>0) {
      const row=ex[0];
      await sbPatch('leaderboard',`?id=eq.${row.id}`,{
        username,
        total_score: row.total_score+ns,
        total_correct: row.total_correct+correctCount,
        total_attempts: row.total_attempts+1,
        updated_at: new Date().toISOString()
      });
    } else {
      await sbPost('leaderboard',{user_id:userId,username,total_score:ns,total_correct:correctCount,total_attempts:1});
    }
  } catch(e){console.warn('LB update failed:',e.message);}
}

function retryChapter(){startQuizWithLevel(currentLevel);}

// ============================================================
// REVIEW
// ============================================================
function reviewAnswers(){buildReview();showScreen('review');}
function buildReview(){
  const L=['A','B','C','D'];
  document.getElementById('review-list').innerHTML=currentQuestions.map((q,i)=>{
    const ua=userAnswers[i],ok=ua===q.ans,sk=ua===null;
    const cc=sk?'rc-s':ok?'rc-c':'rc-w',bc=sk?'s':ok?'c':'w',bt=sk?'‚è≠ Skipped':ok?'‚úÖ Correct':'‚ùå Wrong';
    const opts=q.opts.map((o,oi)=>`<div class="rc-opt ${oi===q.ans?'ic':oi===ua&&!ok?'iw':''}"><b>(${L[oi]})</b><span>${o}</span></div>`).join('');
    return `<div class="review-card ${cc}">
      <div class="rc-header"><span class="rc-qnum">Q${i+1}</span><span class="rc-badge ${bc}">${bt}</span></div>
      <div class="rc-q">${q.q}</div>
      <div class="rc-opts">${opts}</div>
      <div class="rc-expl"><b>üìò NCERT Explanation</b>${q.expl}</div>
    </div>`;
  }).join('');
}

// ============================================================
// LEADERBOARD
// ============================================================
async function openLeaderboard(){showScreen('leaderboard');loadLeaderboard();}
async function loadLeaderboard(){
  document.getElementById('lb-content').innerHTML=`<div class="empty"><div class="empty-icon" style="animation:spin 1s linear infinite;display:inline-block">‚ü≥</div><div class="empty-title" style="margin-top:8px">Loading‚Ä¶</div></div>`;
  try {
    const data=await sbGet('leaderboard','?select=*&order=total_score.desc&limit=50');
    if(!data||data.length===0){
      document.getElementById('lb-content').innerHTML=`<div class="empty"><div class="empty-icon">üèÜ</div><div class="empty-title">No scores yet</div><div class="empty-sub">Complete a quiz to appear here</div></div>`;
      return;
    }
    document.getElementById('lb-content').innerHTML=data.map((row,i)=>{
      const rk=i+1,isYou=row.user_id===userId;
      const rkCls=rk===1?'r1':rk===2?'r2':rk===3?'r3':'rn';
      const rkLabel=rk<=3?['ü•á','ü•à','ü•â'][rk-1]:rk;
      const sc=rk===1?'#C89B14':rk<=3?'var(--purple)':'var(--blue)';
      return `<div class="lb-card" ${isYou?'style="background:rgba(90,45,130,0.05);border:2px solid rgba(90,45,130,0.2);"':''}>
        <div class="lb-rank ${rkCls}">${rkLabel}</div>
        <div class="lb-info">
          <div class="lb-name">${row.username||'Anonymous'}${isYou?'<span class="you-tag">You</span>':''}</div>
          <div class="lb-meta">${row.total_attempts} attempt${row.total_attempts!==1?'s':''} ¬∑ ${row.total_correct} correct</div>
        </div>
        <div class="lb-score" style="color:${sc}">${row.total_score}</div>
      </div>`;
    }).join('');
  } catch(e){
    document.getElementById('lb-content').innerHTML=`<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Could not load</div><div class="empty-sub">${e.message}</div></div>`;
  }
}

// ============================================================
// ANALYTICS
// ============================================================
async function openAnalytics(){showScreen('analytics');loadAnalytics();}
async function loadAnalytics(){
  document.getElementById('ana-content').innerHTML=`<div class="empty"><div class="empty-icon" style="animation:spin 1s linear infinite;display:inline-block">‚ü≥</div><div class="empty-title" style="margin-top:8px">Loading analytics‚Ä¶</div></div>`;
  try {
    const hist=await sbGet('progress',`?user_id=eq.${userId}&order=attempted_at.desc&limit=100`);
    if(!hist||hist.length===0){
      document.getElementById('ana-content').innerHTML=`<div class="empty"><div class="empty-icon">üìä</div><div class="empty-title">No history yet</div><div class="empty-sub">Complete quizzes to see your analytics</div></div>`;
      return;
    }
    const totAttempts=hist.length,totCorrect=hist.reduce((s,r)=>s+r.correct,0),totWrong=hist.reduce((s,r)=>s+r.wrong,0),totScore=hist.reduce((s,r)=>s+r.neet_score,0);
    const acc=totCorrect+totWrong>0?Math.round(totCorrect/(totCorrect+totWrong)*100):0;
    const bySub={};hist.forEach(r=>{if(!bySub[r.subject])bySub[r.subject]={c:0,w:0};bySub[r.subject].c+=r.correct;bySub[r.subject].w+=r.wrong;});
    const byLvl={basic:0,intermediate:0,advanced:0};hist.forEach(r=>{if(byLvl[r.level]!==undefined)byLvl[r.level]++;});
    const subCols={physics:'var(--blue)',biology:'var(--green-light)',chemistry:'var(--amber)'};
    const subIcons={physics:'‚öõÔ∏è',biology:'üß¨',chemistry:'üß™'};
    const bars=Object.entries(bySub).map(([sub,d])=>{
      const a=d.c+d.w>0?Math.round(d.c/(d.c+d.w)*100):0;
      return `<div class="bar-row"><div class="bar-label">${subIcons[sub]||''} ${sub.charAt(0).toUpperCase()+sub.slice(1)}</div><div class="bar-wrap"><div class="bar-fill" style="width:${a}%;background:${subCols[sub]||'var(--blue)'}"></div></div><div class="bar-pct">${a}%</div></div>`;
    }).join('');
    const recent=hist.slice(0,10).map(r=>{
      const icon={physics:'‚öõÔ∏è',biology:'üß¨',chemistry:'üß™'}[r.subject]||'üìö';
      const bg={physics:'rgba(26,62,140,0.1)',biology:'rgba(46,155,90,0.1)',chemistry:'rgba(192,80,32,0.1)'}[r.subject]||'#eee';
      const sc=r.neet_score>=0?'var(--green-light)':'#ff6b6b';
      const dt=new Date(r.attempted_at).toLocaleDateString('en-IN',{day:'numeric',month:'short'});
      return `<div class="hist-item"><div class="hist-icon" style="background:${bg}">${icon}</div><div class="hist-info"><div class="hist-name">${r.chapter}</div><div class="hist-meta">${r.level} ¬∑ ${r.correct}‚úÖ ${r.wrong}‚ùå ¬∑ ${dt}</div></div><div class="hist-score" style="color:${sc}">${r.neet_score>0?'+':''}${r.neet_score}</div></div>`;
    }).join('');
    document.getElementById('ana-content').innerHTML=`
      <div class="ana-card">
        <div class="ana-title">Overall Stats</div>
        <div class="big-grid">
          <div class="ana-stat"><div class="ana-val" style="color:var(--gold)">${totScore}</div><div class="ana-lbl">Total Score</div></div>
          <div class="ana-stat"><div class="ana-val" style="color:var(--blue)">${totAttempts}</div><div class="ana-lbl">Quizzes Done</div></div>
          <div class="ana-stat"><div class="ana-val" style="color:var(--green-light)">${acc}%</div><div class="ana-lbl">Accuracy</div></div>
          <div class="ana-stat"><div class="ana-val" style="color:var(--purple)">${totCorrect}</div><div class="ana-lbl">Total Correct</div></div>
        </div>
      </div>
      <div class="ana-card">
        <div class="ana-title">Accuracy by Subject</div>
        ${bars||'<div style="font-size:0.85rem;color:var(--text-mid)">No data yet</div>'}
      </div>
      <div class="ana-card">
        <div class="ana-title">Level Distribution</div>
        <div style="display:flex;gap:10px;">
          <div class="ana-stat" style="flex:1"><div class="ana-val" style="color:var(--green-light)">${byLvl.basic}</div><div class="ana-lbl">üü¢ Basic</div></div>
          <div class="ana-stat" style="flex:1"><div class="ana-val" style="color:var(--gold)">${byLvl.intermediate}</div><div class="ana-lbl">üü° Inter</div></div>
          <div class="ana-stat" style="flex:1"><div class="ana-val" style="color:#ff6b6b">${byLvl.advanced}</div><div class="ana-lbl">üî¥ Advanced</div></div>
        </div>
      </div>
      <div class="ana-card">
        <div class="ana-title">Recent Attempts</div>
        ${recent}
      </div>`;
  } catch(e){
    document.getElementById('ana-content').innerHTML=`<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Could not load</div><div class="empty-sub">${e.message}</div></div>`;
  }
}

// ============================================================
// EXIT / DIALOG
// ============================================================
function exitQuiz(){document.getElementById('dialog').classList.remove('hidden');}
function closeDialog(){document.getElementById('dialog').classList.add('hidden');}
function confirmExit(){closeDialog();goTopics();}

// ============================================================
// PYQ STATE & DATA
// ============================================================
const PYQ_YEARS = [2024,2023,2022,2021,2020,2019,2018,2017];
let pyqSelectedYear = 2024;
let pyqSelectedSubject = 'all';
let pyqQuestions = [];
let pyqIndex = 0;
let pyqScore = 0, pyqCorrect = 0, pyqWrong = 0, pyqSkip = 0;
let pyqAnswers = [];
let pyqAutoTimer = null;
let pyqAutoCountdown = null;

// Fallback PYQ questions (real NEET PYQs)
const PYQ_FALLBACK = [
  {year:2023,subject:'biology',q:"Which of the following is NOT a characteristic of living organisms?",opts:["Growth","Metabolism","Ability to reproduce","Consciousness"],ans:3,expl:"Consciousness is debated as a defining feature; it is not universally accepted as a characteristic of ALL living organisms. Growth, metabolism, and reproduction are universally accepted."},
  {year:2023,subject:'physics',q:"A body is moving along a circular path with variable speed. It has:",opts:["A radial acceleration only","A tangential acceleration only","Both radial and tangential accelerations","No acceleration"],ans:2,expl:"Variable speed means tangential acceleration exists; circular path means centripetal (radial) acceleration also exists. Both act simultaneously."},
  {year:2023,subject:'chemistry',q:"Which of the following is the correct IUPAC name of CH‚ÇÉ‚àíCH‚ÇÇ‚àíCHO?",opts:["Propanal","Propanone","Propan-1-ol","Propanoic acid"],ans:0,expl:"CH‚ÇÉ‚àíCH‚ÇÇ‚àíCHO is a 3-carbon aldehyde. IUPAC name is Propanal."},
  {year:2022,subject:'biology',q:"DNA replication occurs in which phase of cell cycle?",opts:["G1 phase","S phase","G2 phase","M phase"],ans:1,expl:"DNA synthesis/replication occurs during the S (Synthesis) phase of interphase in the cell cycle."},
  {year:2022,subject:'physics',q:"The de Broglie wavelength associated with an electron accelerated through a potential difference V is proportional to:",opts:["V","1/V","1/‚àöV","‚àöV"],ans:2,expl:"Œª = h/‚àö(2meV), so Œª ‚àù 1/‚àöV."},
  {year:2022,subject:'chemistry',q:"Which of the following acts as a Lewis acid?",opts:["NH‚ÇÉ","H‚ÇÇO","BF‚ÇÉ","F‚Åª"],ans:2,expl:"BF‚ÇÉ has an empty p orbital and can accept electron pairs, making it a Lewis acid."},
  {year:2021,subject:'biology',q:"Bowman's capsule is part of which structure?",opts:["Neuron","Nephron","Liver lobule","Alveolus"],ans:1,expl:"Bowman's capsule is the cup-shaped structure at the beginning of the nephron that surrounds the glomerulus."},
  {year:2021,subject:'physics',q:"A photon of energy E has momentum p. If c is the speed of light, then:",opts:["p = Ec","p = E/c","p = Ec¬≤","p = E/c¬≤"],ans:1,expl:"For photon: E = pc (from relativistic energy-momentum relation where rest mass = 0), so p = E/c."},
  {year:2021,subject:'chemistry',q:"Which of the following is an example of a heterogeneous catalyst?",opts:["H‚ÇÇSO‚ÇÑ in esterification","Enzyme in fermentation","V‚ÇÇO‚ÇÖ in Contact process","HCl in hydrolysis"],ans:2,expl:"V‚ÇÇO‚ÇÖ (solid) catalyses SO‚ÇÇ to SO‚ÇÉ (gas) ‚Äî reactant and catalyst are in different phases. This is heterogeneous catalysis."},
  {year:2020,subject:'biology',q:"Which pigment absorbs light at 700 nm wavelength?",opts:["Chlorophyll b","Chlorophyll a","Carotenoids","Phycoerythrin"],ans:1,expl:"Chlorophyll a absorbs maximum light at 680 nm and 700 nm (P700 reaction centre)."},
  {year:2020,subject:'physics',q:"Two parallel plates are charged with opposite charges. The electric field between the plates is E. If the separation is doubled keeping the charge same, the field becomes:",opts:["2E","E","E/2","E/4"],ans:1,expl:"For a parallel plate capacitor E = œÉ/Œµ‚ÇÄ which depends only on surface charge density (œÉ). Since Q and plate area unchanged, œÉ unchanged, so E unchanged."},
  {year:2020,subject:'chemistry',q:"Glucose reacts with excess Tollens' reagent to give:",opts:["Silver mirror","Black precipitate","White precipitate","Blue solution"],ans:0,expl:"Aldehydes (including glucose) reduce Tollens' reagent (ammoniacal AgNO‚ÇÉ) to produce a silver mirror on the test tube walls."},
  {year:2019,subject:'biology',q:"Which of the following represents the correct sequence of events in mitosis?",opts:["Prophase‚ÜíMetaphase‚ÜíAnaphase‚ÜíTelophase","Metaphase‚ÜíProphase‚ÜíTelophase‚ÜíAnaphase","Prophase‚ÜíAnaphase‚ÜíMetaphase‚ÜíTelophase","Anaphase‚ÜíTelophase‚ÜíProphase‚ÜíMetaphase"],ans:0,expl:"Mitosis proceeds: Prophase (chromosomes condense) ‚Üí Metaphase (align at equator) ‚Üí Anaphase (chromatids separate) ‚Üí Telophase (nuclear envelope reforms)."},
  {year:2019,subject:'physics',q:"The work done by a magnetic force on a moving charge is always:",opts:["Positive","Negative","Zero","Depends on velocity"],ans:2,expl:"Magnetic force is always perpendicular to velocity, hence displacement. W = F¬∑d¬∑cosŒ∏ = F¬∑d¬∑cos90¬∞ = 0."},
  {year:2019,subject:'chemistry',q:"Nucleophilic substitution (SN2) reaction is favoured by:",opts:["Tertiary substrate","Polar protic solvent","Strong nucleophile and primary substrate","Weak nucleophile"],ans:2,expl:"SN2 requires a strong nucleophile attacking a less sterically hindered (primary) substrate in a polar aprotic solvent."},
  {year:2018,subject:'biology',q:"Streptomycin is obtained from which microorganism?",opts:["Streptomyces griseus","Streptomyces venezuelae","Penicillium notatum","Bacillus subtilis"],ans:0,expl:"Streptomycin, the first aminoglycoside antibiotic, is produced by the soil bacterium Streptomyces griseus."},
  {year:2018,subject:'physics',q:"What is the dimension of gravitational constant G?",opts:["M‚Åª¬πL¬≥T‚Åª¬≤","ML¬≤T‚Åª¬≤","M‚Åª¬πL¬≤T‚Åª¬≤","M‚Åª¬≤L¬≥T‚Åª¬≤"],ans:0,expl:"From F = Gm‚ÇÅm‚ÇÇ/r¬≤, G = Fr¬≤/m¬≤ ‚Üí [G] = MLT‚Åª¬≤ √ó L¬≤ / M¬≤ = M‚Åª¬πL¬≥T‚Åª¬≤."},
  {year:2018,subject:'chemistry',q:"Which of the following has the highest boiling point?",opts:["n-Butane","Isobutane","n-Pentane","Neopentane"],ans:2,expl:"Boiling point increases with surface area (Van der Waals forces). n-Pentane has the most carbons and longest chain among the options."},
  {year:2017,subject:'biology',q:"Which hormone is responsible for the 'fight or flight' response?",opts:["Insulin","Thyroxine","Adrenaline (Epinephrine)","Cortisol"],ans:2,expl:"Adrenaline (epinephrine) from adrenal medulla rapidly prepares the body for fight-or-flight: increases heart rate, blood glucose, and redirects blood flow."},
  {year:2017,subject:'physics',q:"A lens of focal length f forms a real image of an object at the same position as the object. The distance of the object from the lens is:",opts:["f","2f","f/2","3f"],ans:1,expl:"For image to coincide with object (real), rays must retrace. Object must be at centre of curvature (2f for a thin lens), so object distance = 2f."},
];

function openPYQ() {
  renderPYQYears();
  showScreen('pyq');
}

function renderPYQYears() {
  document.getElementById('pyq-year-grid').innerHTML = PYQ_YEARS.map(y =>
    `<button class="pyq-year-btn${y===pyqSelectedYear?' active':''}" onclick="setPYQYear(${y})">${y}</button>`
  ).join('');
}

function setPYQYear(y) {
  pyqSelectedYear = y;
  document.querySelectorAll('.pyq-year-btn').forEach(b => b.classList.toggle('active', parseInt(b.textContent)===y));
}

function setPYQSubject(s) {
  pyqSelectedSubject = s;
  ['all','physics','biology','chemistry'].forEach(id => {
    document.getElementById('pyq-sub-'+id).classList.toggle('active', id===s);
  });
}

async function startPYQAttempt() {
  showScreen('loading');
  document.getElementById('loading-text').textContent = 'Loading PYQ questions‚Ä¶';
  document.getElementById('loading-sub').textContent = `NEET ${pyqSelectedYear} ¬∑ ${pyqSelectedSubject==='all'?'All Subjects':pyqSelectedSubject.charAt(0).toUpperCase()+pyqSelectedSubject.slice(1)}`;

  let qs = await fetchPYQFromDB(pyqSelectedYear, pyqSelectedSubject);
  if (!qs || qs.length === 0) {
    // Use fallback
    qs = PYQ_FALLBACK.filter(q =>
      (pyqSelectedYear === 'all' || q.year === pyqSelectedYear) &&
      (pyqSelectedSubject === 'all' || q.subject === pyqSelectedSubject)
    );
    if (qs.length === 0) qs = shuffle([...PYQ_FALLBACK]).slice(0, 10);
    showToast('üí° Sample PYQs loaded ‚Äî add real ones to Supabase!', 'ok');
  }

  pyqQuestions = shuffle(qs);
  pyqIndex = 0; pyqScore = 0; pyqCorrect = 0; pyqWrong = 0; pyqSkip = 0;
  pyqAnswers = new Array(pyqQuestions.length).fill(null);
  clearPYQTimers();

  document.getElementById('pyq-quiz-title').textContent = `NEET PYQ ${pyqSelectedYear==='all'?'Mix':pyqSelectedYear}`;
  document.getElementById('pyq-score-pill').textContent = 'Score: 0';
  document.getElementById('pyq-timer-wrap').classList.add('hidden');
  renderPYQQuestion();
  showScreen('pyq-quiz');
}

async function fetchPYQFromDB(year, subject) {
  try {
    let query = '?select=*';
    if (year !== 'all') query += `&year=eq.${year}`;
    if (subject !== 'all') query += `&subject=eq.${subject}`;
    query += '&limit=30';
    const data = await sbGet('pyq_questions', query);
    return shuffle(data).slice(0, 20);
  } catch(e) { console.warn('PYQ DB fetch failed:', e.message); return null; }
}

function renderPYQQuestion() {
  clearPYQTimers();
  document.getElementById('pyq-timer-wrap').classList.add('hidden');

  const q = pyqQuestions[pyqIndex];
  const L = ['A','B','C','D'];
  const pct = (pyqIndex / pyqQuestions.length) * 100;
  document.getElementById('pyq-quiz-progress').style.width = pct + '%';
  document.getElementById('pyq-quiz-counter').textContent = `Q ${pyqIndex+1} / ${pyqQuestions.length}`;
  document.getElementById('pyq-year-pill').textContent = q.year || pyqSelectedYear;

  document.getElementById('pyq-quiz-content').innerHTML = `
    <div class="question-card">
      <div class="pyq-year-tag">üìÖ NEET ${q.year||pyqSelectedYear} ¬∑ ${(q.subject||'').toUpperCase()}</div>
      <div class="q-num">QUESTION ${pyqIndex+1}</div>
      <div class="q-text">${q.q}</div>
    </div>
    <div class="options-list" id="pyq-opts">
      ${q.opts.map((o,i)=>`<button class="opt-btn" id="pq${i}" onclick="pickPYQ(${i})"><div class="opt-letter">${L[i]}</div><div class="opt-text">${o}</div></button>`).join('')}
    </div>
    <div id="pyq-fb"></div>`;
}

function pickPYQ(sel) {
  const q = pyqQuestions[pyqIndex];
  const L = ['A','B','C','D'];
  pyqAnswers[pyqIndex] = sel;
  document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
  const ok = sel === q.ans;
  document.getElementById('pq'+sel).classList.add(ok?'correct':'wrong');
  document.getElementById('pq'+sel).querySelector('.opt-letter').textContent = ok?'‚úì':'‚úó';
  if (!ok) {
    document.getElementById('pq'+q.ans).classList.add('revealed');
    document.getElementById('pq'+q.ans).querySelector('.opt-letter').textContent = '‚úì';
  }
  if (ok) { pyqScore+=4; pyqCorrect++; } else { pyqScore-=1; pyqWrong++; }
  document.getElementById('pyq-score-pill').textContent = `Score: ${pyqScore}`;
  const pill = document.getElementById('pyq-score-pill');
  pill.classList.remove('pop','shake'); void pill.offsetWidth; pill.classList.add(ok?'pop':'shake');

  const isLast = pyqIndex >= pyqQuestions.length - 1;
  document.getElementById('pyq-fb').innerHTML = `
    <div class="feedback ${ok?'correct':'wrong'}">${ok?'‚úÖ Correct! +4 points':`‚ùå Wrong! ‚àí1 pt ¬∑ Correct: (${L[q.ans]}) ${q.opts[q.ans]}`}</div>
    <div class="expl-box"><div class="expl-label">üìò EXPLANATION</div><div class="expl-text">${q.expl}</div></div>
    <button class="next-btn" id="pyq-next-btn" onclick="nextPYQ()">${isLast?'üìä See Results':'Next Question ‚Üí'}</button>`;

  // Start 10s auto-advance timer
  startPYQAutoTimer(isLast);
}

function startPYQAutoTimer(isLast) {
  const wrap = document.getElementById('pyq-timer-wrap');
  const bar = document.getElementById('pyq-timer-bar');
  const secEl = document.getElementById('pyq-timer-sec');
  wrap.classList.remove('hidden');
  bar.style.transition = 'none';
  bar.style.width = '100%';
  void bar.offsetWidth;

  let sec = 10;
  secEl.textContent = sec;
  // Animate bar from 100% to 0% over 10s
  bar.style.transition = 'width 10s linear';
  bar.style.width = '0%';

  pyqAutoCountdown = setInterval(() => {
    sec--;
    secEl.textContent = sec;
    if (sec <= 0) {
      clearInterval(pyqAutoCountdown);
      pyqAutoCountdown = null;
    }
  }, 1000);

  pyqAutoTimer = setTimeout(() => {
    wrap.classList.add('hidden');
    if (isLast) showPYQResults();
    else { pyqIndex++; renderPYQQuestion(); }
  }, 10000);
}

function clearPYQTimers() {
  if (pyqAutoTimer) { clearTimeout(pyqAutoTimer); pyqAutoTimer = null; }
  if (pyqAutoCountdown) { clearInterval(pyqAutoCountdown); pyqAutoCountdown = null; }
}

function nextPYQ() {
  clearPYQTimers();
  document.getElementById('pyq-timer-wrap').classList.add('hidden');
  if (pyqIndex < pyqQuestions.length - 1) { pyqIndex++; renderPYQQuestion(); }
  else showPYQResults();
}

function showPYQResults() {
  // Reuse the existing results screen but fill with PYQ data
  pyqSkip = pyqAnswers.filter(a => a === null).length;
  const total = pyqQuestions.length;
  const ns = (pyqCorrect*4) - (pyqWrong*1);
  const maxNs = total * 4;
  const pct = Math.round((pyqCorrect / total) * 100);

  document.getElementById('r-correct').textContent = pyqCorrect;
  document.getElementById('r-wrong').textContent = pyqWrong;
  document.getElementById('r-skip').textContent = pyqSkip;
  document.getElementById('r-total').textContent = total;
  document.getElementById('r-neet').textContent = ns;
  document.getElementById('r-max').textContent = `/ ${maxNs} maximum`;

  const b = document.getElementById('perf-badge'); b.className='perf-badge';
  if(pct>=80){b.classList.add('perf-excellent');b.textContent='üèÜ Excellent!';}
  else if(pct>=50){b.classList.add('perf-good');b.textContent='üëç Good Job!';}
  else{b.classList.add('perf-practice');b.textContent='üìö Keep Practising';}

  // Override result buttons for PYQ context
  document.getElementById('result-btns-wrap').innerHTML = `
    <button class="result-btn primary" onclick="startPYQAttempt()">üîÑ Retry PYQ</button>
    <button class="result-btn secondary" onclick="reviewPYQAnswers()">üìñ Review Answers</button>
    <button class="result-btn secondary" onclick="openPYQ()">üìÖ Choose Another Year</button>
    <button class="result-btn secondary" onclick="openLeaderboard()">üèÜ View Leaderboard</button>`;

  showScreen('results');

  let cur=0; const el=document.getElementById('score-display');
  const step=Math.ceil(Math.abs(ns)/40)||1;
  const iv=setInterval(()=>{if(Math.abs(cur-ns)<=step){cur=ns;clearInterval(iv);}else cur+=(ns>0?step:-step);el.textContent=cur;},28);
  setTimeout(()=>{document.getElementById('score-arc').style.strokeDashoffset=502*(1-Math.max(0,pct)/100);},100);

  // Save to Supabase
  document.getElementById('save-status').textContent='üíæ Saving PYQ attempt‚Ä¶';
  sbPost('progress',{user_id:userId,subject:'pyq_'+pyqSelectedSubject,chapter:'NEET PYQ '+(pyqSelectedYear==='all'?'Mix':pyqSelectedYear),level:'attempt',correct:pyqCorrect,wrong:pyqWrong,skipped:pyqSkip,neet_score:ns})
    .then(()=>updateLeaderboard(ns))
    .then(()=>{document.getElementById('save-status').textContent='‚úÖ Saved!';})
    .catch(()=>{document.getElementById('save-status').textContent='‚ö†Ô∏è Could not save (offline?)';});
}

function reviewPYQAnswers() {
  const L=['A','B','C','D'];
  document.getElementById('review-list').innerHTML = pyqQuestions.map((q,i)=>{
    const ua=pyqAnswers[i],ok=ua===q.ans,sk=ua===null;
    const cc=sk?'rc-s':ok?'rc-c':'rc-w',bc=sk?'s':ok?'c':'w',bt=sk?'‚è≠ Skipped':ok?'‚úÖ Correct':'‚ùå Wrong';
    const opts=q.opts.map((o,oi)=>`<div class="rc-opt ${oi===q.ans?'ic':oi===ua&&!ok?'iw':''}"><b>(${L[oi]})</b><span>${o}</span></div>`).join('');
    return `<div class="review-card ${cc}">
      <div class="rc-header"><span class="rc-qnum">Q${i+1} ¬∑ NEET ${q.year||pyqSelectedYear}</span><span class="rc-badge ${bc}">${bt}</span></div>
      <div class="rc-q">${q.q}</div>
      <div class="rc-opts">${opts}</div>
      <div class="rc-expl"><b>üìò Explanation</b>${q.expl}</div>
    </div>`;
  }).join('');
  showScreen('review');
}

function exitPYQQuiz() {
  clearPYQTimers();
  // Show custom exit dialog
  openPYQ();
}


// ============================================================
// TOAST
// ============================================================
function showToast(msg,type='ok'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`toast ${type}`;
  void t.offsetWidth;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}
</script>
</body>
</html>
